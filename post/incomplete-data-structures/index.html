<!DOCTYPE html>
<html>
  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>I&#39;m Not Mutable, I&#39;m Partially Instantiated</title>
  <meta name="description" content="Incomplete data structures challenge our notion of mutability" />
  <link rel="stylesheet" href="/assets/css/style.css" type="text/css">
  <meta property="og:url" content="https://blog.dnmfarrell.com/post/incomplete-data-structures/" />
  <meta property="og:title" content="I&#39;m Not Mutable, I&#39;m Partially Instantiated" />
  <meta property="og:description" content="Incomplete data structures challenge our notion of mutability">
  <meta property="og:site_name" content="blog.dnmfarrell.com" />
  <meta property="og:type" content="article" />
  <meta property="og:article:published_time" content="2024-11-06T02:02:24Z" />
  <meta property="og:article:tag" content="prolog" />
  <meta property="og:article:tag" content="data-structures" />
  <meta property="og:article:tag" content="difference-lists" />
  
  <script type="text/javascript" src="/scripts/tau-prolog.js"></script>

</head>

  <body>
    Looking for help building the future? Let's connect on <a href="https://www.linkedin.com/in/david-farrell-a27a16296/">LinkedIn</a>

    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-ZZXLDS5VZ0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-ZZXLDS5VZ0');
</script>
<a href="/">
  <h1>Code</h1>
</a>

    <main>
      

<div class="post-title">
  <a href=https://blog.dnmfarrell.com/post/incomplete-data-structures/><h2>I&#39;m Not Mutable, I&#39;m Partially Instantiated</h2></a>
  <p class="description">Incomplete data structures challenge our notion of mutability</p>
  <p><em class="date">November 6, 2024</em></p>
</div>

<p>Chapter 15 from <a href="https://mitpress.mit.edu/9780262691635/the-art-of-prolog/">The Art of Prolog</a> contains this dictionary implementation:</p>
<p><script>var lookup = pl.create();</script>

<script>

function eval_1e8240ec16e31b6d34183af76f3ebdbb() {
  let output = "";
  let answ = function() {
    lookup.answer({
      success: function(answer) {
        let msg = lookup.format_answer(answer);
        output += `${msg};\n`;
        answ();
      },
      fail: function() {
        if (output == "") {
          output = "false."
        } else {
          output = output.substr(0, output.length-2) + ".";
        }
        document.querySelector('textarea#o1e8240ec16e31b6d34183af76f3ebdbb').value = output;
        let cons = document.querySelector('textarea#o1e8240ec16e31b6d34183af76f3ebdbb');
        cons.style.height = "1px";
        cons.style.height = (cons.scrollHeight)+"px";
        output = "";
      },
    });
  };
  let code = document.querySelector('textarea#i1e8240ec16e31b6d34183af76f3ebdbb');
  code.style.height = "1px";
  code.style.height = (code.scrollHeight)+"px";
  code.value.substr(0,3) != '?- '
  ? lookup.consult(
    `${code.value}\n`, { 
      success: function() {
        code.style.borderBottomColor = '#4DA167';
        let cons = document.querySelector('textarea#o1e8240ec16e31b6d34183af76f3ebdbb');
        cons.value = "OK.";
        cons.style.height = "1px";
        cons.style.height = (cons.scrollHeight)+"px";
      },
      error: function(err) {
        code.style.borderBottomColor = '#EC0B43';
        document.querySelector('textarea#o1e8240ec16e31b6d34183af76f3ebdbb').value = err;
        let cons = document.querySelector('textarea#o1e8240ec16e31b6d34183af76f3ebdbb');
        cons.style.height = "1px";
        cons.style.height = (cons.scrollHeight)+"px";
      },
    })
  : lookup.query(
    `${code.value.substr(3)}`, {
      success: function() {
        code.style.borderBottomColor = '#4DA167';
        document.querySelector('textarea#o1e8240ec16e31b6d34183af76f3ebdbb').value = "";
        answ();
      },
      error: function(err) {
        code.style.borderBottomColor = '#EC0B43';
        document.querySelector('textarea#o1e8240ec16e31b6d34183af76f3ebdbb').value = err;
        let cons = document.querySelector('textarea#o1e8240ec16e31b6d34183af76f3ebdbb');
        cons.style.height = "1px";
        cons.style.height = (cons.scrollHeight)+"px";
      },
    });
}
addEventListener("DOMContentLoaded", (event) => { eval_1e8240ec16e31b6d34183af76f3ebdbb() });
</script>
<div style="margin-bottom:24px">
<textarea class="eval_in" id="i1e8240ec16e31b6d34183af76f3ebdbb" onkeyup="eval_1e8240ec16e31b6d34183af76f3ebdbb()">
lookup(Key, dict(Key,X,Left,Right), Value) :-
    !,X=Value.
lookup(Key, dict(Keyl,X,Left,Right), Value) :-
    Key &lt; Keyl, lookup(Key,Left,Value).
lookup(Key, dict(Keyl,X,Left,Right), Value) :-
    Key &gt; Keyl, lookup(Key,Right,Value).</textarea>
<textarea class="eval_out" readonly id="o1e8240ec16e31b6d34183af76f3ebdbb"></textarea>
</div>
</p>
<p>Believe it or not, these six lines of code implement a dictionary as an ordered, binary search tree. The rule <code>lookup/3</code> can be used to both add to and get from the dictionary.</p>
<p>This query calls <code>lookup/3</code> with a key, a variable, and a value. The variable is instantiated to a new dictionary containing the key-value pair and variables (beginning with <code>_</code>) in the left and right branches:</p>
<script>

function eval_dde63be5eed9a804e2eb144e2e0a970b() {
  let output = "";
  let answ = function() {
    lookup.answer({
      success: function(answer) {
        let msg = lookup.format_answer(answer);
        output += `${msg};\n`;
        answ();
      },
      fail: function() {
        if (output == "") {
          output = "false."
        } else {
          output = output.substr(0, output.length-2) + ".";
        }
        document.querySelector('textarea#odde63be5eed9a804e2eb144e2e0a970b').value = output;
        let cons = document.querySelector('textarea#odde63be5eed9a804e2eb144e2e0a970b');
        cons.style.height = "1px";
        cons.style.height = (cons.scrollHeight)+"px";
        output = "";
      },
    });
  };
  let code = document.querySelector('textarea#idde63be5eed9a804e2eb144e2e0a970b');
  code.style.height = "1px";
  code.style.height = (code.scrollHeight)+"px";
  code.value.substr(0,3) != '?- '
  ? lookup.consult(
    `${code.value}\n`, { 
      success: function() {
        code.style.borderBottomColor = '#4DA167';
        let cons = document.querySelector('textarea#odde63be5eed9a804e2eb144e2e0a970b');
        cons.value = "OK.";
        cons.style.height = "1px";
        cons.style.height = (cons.scrollHeight)+"px";
      },
      error: function(err) {
        code.style.borderBottomColor = '#EC0B43';
        document.querySelector('textarea#odde63be5eed9a804e2eb144e2e0a970b').value = err;
        let cons = document.querySelector('textarea#odde63be5eed9a804e2eb144e2e0a970b');
        cons.style.height = "1px";
        cons.style.height = (cons.scrollHeight)+"px";
      },
    })
  : lookup.query(
    `${code.value.substr(3)}`, {
      success: function() {
        code.style.borderBottomColor = '#4DA167';
        document.querySelector('textarea#odde63be5eed9a804e2eb144e2e0a970b').value = "";
        answ();
      },
      error: function(err) {
        code.style.borderBottomColor = '#EC0B43';
        document.querySelector('textarea#odde63be5eed9a804e2eb144e2e0a970b').value = err;
        let cons = document.querySelector('textarea#odde63be5eed9a804e2eb144e2e0a970b');
        cons.style.height = "1px";
        cons.style.height = (cons.scrollHeight)+"px";
      },
    });
}
addEventListener("DOMContentLoaded", (event) => { eval_dde63be5eed9a804e2eb144e2e0a970b() });
</script>
<div style="margin-bottom:24px">
<textarea class="eval_in" id="idde63be5eed9a804e2eb144e2e0a970b" onkeyup="eval_dde63be5eed9a804e2eb144e2e0a970b()">
?- lookup(123, Dict, &#34;foo&#34;).</textarea>
<textarea class="eval_out" readonly id="odde63be5eed9a804e2eb144e2e0a970b"></textarea>
</div>

<p>This query includes a second clause which adds another key-value pair, which is placed in the right branch of the first pair:</p>
<script>

function eval_0433e4e0a8a4c0b8e9b3a80849488ad0() {
  let output = "";
  let answ = function() {
    lookup.answer({
      success: function(answer) {
        let msg = lookup.format_answer(answer);
        output += `${msg};\n`;
        answ();
      },
      fail: function() {
        if (output == "") {
          output = "false."
        } else {
          output = output.substr(0, output.length-2) + ".";
        }
        document.querySelector('textarea#o0433e4e0a8a4c0b8e9b3a80849488ad0').value = output;
        let cons = document.querySelector('textarea#o0433e4e0a8a4c0b8e9b3a80849488ad0');
        cons.style.height = "1px";
        cons.style.height = (cons.scrollHeight)+"px";
        output = "";
      },
    });
  };
  let code = document.querySelector('textarea#i0433e4e0a8a4c0b8e9b3a80849488ad0');
  code.style.height = "1px";
  code.style.height = (code.scrollHeight)+"px";
  code.value.substr(0,3) != '?- '
  ? lookup.consult(
    `${code.value}\n`, { 
      success: function() {
        code.style.borderBottomColor = '#4DA167';
        let cons = document.querySelector('textarea#o0433e4e0a8a4c0b8e9b3a80849488ad0');
        cons.value = "OK.";
        cons.style.height = "1px";
        cons.style.height = (cons.scrollHeight)+"px";
      },
      error: function(err) {
        code.style.borderBottomColor = '#EC0B43';
        document.querySelector('textarea#o0433e4e0a8a4c0b8e9b3a80849488ad0').value = err;
        let cons = document.querySelector('textarea#o0433e4e0a8a4c0b8e9b3a80849488ad0');
        cons.style.height = "1px";
        cons.style.height = (cons.scrollHeight)+"px";
      },
    })
  : lookup.query(
    `${code.value.substr(3)}`, {
      success: function() {
        code.style.borderBottomColor = '#4DA167';
        document.querySelector('textarea#o0433e4e0a8a4c0b8e9b3a80849488ad0').value = "";
        answ();
      },
      error: function(err) {
        code.style.borderBottomColor = '#EC0B43';
        document.querySelector('textarea#o0433e4e0a8a4c0b8e9b3a80849488ad0').value = err;
        let cons = document.querySelector('textarea#o0433e4e0a8a4c0b8e9b3a80849488ad0');
        cons.style.height = "1px";
        cons.style.height = (cons.scrollHeight)+"px";
      },
    });
}
addEventListener("DOMContentLoaded", (event) => { eval_0433e4e0a8a4c0b8e9b3a80849488ad0() });
</script>
<div style="margin-bottom:24px">
<textarea class="eval_in" id="i0433e4e0a8a4c0b8e9b3a80849488ad0" onkeyup="eval_0433e4e0a8a4c0b8e9b3a80849488ad0()">
?- lookup(123, Dict, &#34;foo&#34;),
   lookup(456, Dict, &#34;bar&#34;).</textarea>
<textarea class="eval_out" readonly id="o0433e4e0a8a4c0b8e9b3a80849488ad0"></textarea>
</div>

<h3 id="immutable">Immutable?</h3>
<p>Since values in logic programming are immutable - why does adding a key-value pair to the dictionary not need to copy and return a new version of the dictionary?</p>
<p>The answer is because it&rsquo;s an incomplete data structure. The binary tree&rsquo;s left and right branches are variables, whose values can be determined later. So the lookup rule traverses the tree until it finds a matching key, or it finds a variable and &ldquo;unifies&rdquo; that branch making its key and value match its arguments.</p>
<p>Instead of being mutable, the dictionary is partially-instantiated. Think of it as an unfinished sketch of a binary tree, where instead of <code>nil</code>, the leaves have a value of &ldquo;TBD&rdquo;.</p>
<p>Yet it&rsquo;s immutable since once a concrete value is specified, it cannot be changed without making a copy.</p>
<p>A more commonly encountered incomplete data structure is the <a href="https://pbrown.me/blog/difference-lists-explored/">difference list</a>. These are partially-instantiated linked-lists with a variable for a tail. Prepending values to the tail appends them to the list in constant time.</p>
<h3 id="refactoring-the-dictionary">Refactoring the dictionary</h3>
<p>To get a key&rsquo;s value, we provide the value as a variable:</p>
<script>

function eval_84b9b7b6988fb8003c2830f4d597c922() {
  let output = "";
  let answ = function() {
    lookup.answer({
      success: function(answer) {
        let msg = lookup.format_answer(answer);
        output += `${msg};\n`;
        answ();
      },
      fail: function() {
        if (output == "") {
          output = "false."
        } else {
          output = output.substr(0, output.length-2) + ".";
        }
        document.querySelector('textarea#o84b9b7b6988fb8003c2830f4d597c922').value = output;
        let cons = document.querySelector('textarea#o84b9b7b6988fb8003c2830f4d597c922');
        cons.style.height = "1px";
        cons.style.height = (cons.scrollHeight)+"px";
        output = "";
      },
    });
  };
  let code = document.querySelector('textarea#i84b9b7b6988fb8003c2830f4d597c922');
  code.style.height = "1px";
  code.style.height = (code.scrollHeight)+"px";
  code.value.substr(0,3) != '?- '
  ? lookup.consult(
    `${code.value}\n`, { 
      success: function() {
        code.style.borderBottomColor = '#4DA167';
        let cons = document.querySelector('textarea#o84b9b7b6988fb8003c2830f4d597c922');
        cons.value = "OK.";
        cons.style.height = "1px";
        cons.style.height = (cons.scrollHeight)+"px";
      },
      error: function(err) {
        code.style.borderBottomColor = '#EC0B43';
        document.querySelector('textarea#o84b9b7b6988fb8003c2830f4d597c922').value = err;
        let cons = document.querySelector('textarea#o84b9b7b6988fb8003c2830f4d597c922');
        cons.style.height = "1px";
        cons.style.height = (cons.scrollHeight)+"px";
      },
    })
  : lookup.query(
    `${code.value.substr(3)}`, {
      success: function() {
        code.style.borderBottomColor = '#4DA167';
        document.querySelector('textarea#o84b9b7b6988fb8003c2830f4d597c922').value = "";
        answ();
      },
      error: function(err) {
        code.style.borderBottomColor = '#EC0B43';
        document.querySelector('textarea#o84b9b7b6988fb8003c2830f4d597c922').value = err;
        let cons = document.querySelector('textarea#o84b9b7b6988fb8003c2830f4d597c922');
        cons.style.height = "1px";
        cons.style.height = (cons.scrollHeight)+"px";
      },
    });
}
addEventListener("DOMContentLoaded", (event) => { eval_84b9b7b6988fb8003c2830f4d597c922() });
</script>
<div style="margin-bottom:24px">
<textarea class="eval_in" id="i84b9b7b6988fb8003c2830f4d597c922" onkeyup="eval_84b9b7b6988fb8003c2830f4d597c922()">
?- lookup(123, Dict, &#34;foo&#34;),
   lookup(123, Dict, Value).</textarea>
<textarea class="eval_out" readonly id="o84b9b7b6988fb8003c2830f4d597c922"></textarea>
</div>

<p>Checking for existence is a little tricky though:</p>
<script>

function eval_764c785c7efeef721baf5d9e24771be2() {
  let output = "";
  let answ = function() {
    lookup.answer({
      success: function(answer) {
        let msg = lookup.format_answer(answer);
        output += `${msg};\n`;
        answ();
      },
      fail: function() {
        if (output == "") {
          output = "false."
        } else {
          output = output.substr(0, output.length-2) + ".";
        }
        document.querySelector('textarea#o764c785c7efeef721baf5d9e24771be2').value = output;
        let cons = document.querySelector('textarea#o764c785c7efeef721baf5d9e24771be2');
        cons.style.height = "1px";
        cons.style.height = (cons.scrollHeight)+"px";
        output = "";
      },
    });
  };
  let code = document.querySelector('textarea#i764c785c7efeef721baf5d9e24771be2');
  code.style.height = "1px";
  code.style.height = (code.scrollHeight)+"px";
  code.value.substr(0,3) != '?- '
  ? lookup.consult(
    `${code.value}\n`, { 
      success: function() {
        code.style.borderBottomColor = '#4DA167';
        let cons = document.querySelector('textarea#o764c785c7efeef721baf5d9e24771be2');
        cons.value = "OK.";
        cons.style.height = "1px";
        cons.style.height = (cons.scrollHeight)+"px";
      },
      error: function(err) {
        code.style.borderBottomColor = '#EC0B43';
        document.querySelector('textarea#o764c785c7efeef721baf5d9e24771be2').value = err;
        let cons = document.querySelector('textarea#o764c785c7efeef721baf5d9e24771be2');
        cons.style.height = "1px";
        cons.style.height = (cons.scrollHeight)+"px";
      },
    })
  : lookup.query(
    `${code.value.substr(3)}`, {
      success: function() {
        code.style.borderBottomColor = '#4DA167';
        document.querySelector('textarea#o764c785c7efeef721baf5d9e24771be2').value = "";
        answ();
      },
      error: function(err) {
        code.style.borderBottomColor = '#EC0B43';
        document.querySelector('textarea#o764c785c7efeef721baf5d9e24771be2').value = err;
        let cons = document.querySelector('textarea#o764c785c7efeef721baf5d9e24771be2');
        cons.style.height = "1px";
        cons.style.height = (cons.scrollHeight)+"px";
      },
    });
}
addEventListener("DOMContentLoaded", (event) => { eval_764c785c7efeef721baf5d9e24771be2() });
</script>
<div style="margin-bottom:24px">
<textarea class="eval_in" id="i764c785c7efeef721baf5d9e24771be2" onkeyup="eval_764c785c7efeef721baf5d9e24771be2()">
?- lookup(123, Dict, Value).</textarea>
<textarea class="eval_out" readonly id="o764c785c7efeef721baf5d9e24771be2"></textarea>
</div>

<p>The query &ldquo;succeeded&rdquo; but the value didn&rsquo;t exist, we got a variable back! We can use <code>nonvar/1</code> to check that our variable contains a value</p>
<script>

function eval_d4b1c12e1427e0f2712e7421345c38f0() {
  let output = "";
  let answ = function() {
    lookup.answer({
      success: function(answer) {
        let msg = lookup.format_answer(answer);
        output += `${msg};\n`;
        answ();
      },
      fail: function() {
        if (output == "") {
          output = "false."
        } else {
          output = output.substr(0, output.length-2) + ".";
        }
        document.querySelector('textarea#od4b1c12e1427e0f2712e7421345c38f0').value = output;
        let cons = document.querySelector('textarea#od4b1c12e1427e0f2712e7421345c38f0');
        cons.style.height = "1px";
        cons.style.height = (cons.scrollHeight)+"px";
        output = "";
      },
    });
  };
  let code = document.querySelector('textarea#id4b1c12e1427e0f2712e7421345c38f0');
  code.style.height = "1px";
  code.style.height = (code.scrollHeight)+"px";
  code.value.substr(0,3) != '?- '
  ? lookup.consult(
    `${code.value}\n`, { 
      success: function() {
        code.style.borderBottomColor = '#4DA167';
        let cons = document.querySelector('textarea#od4b1c12e1427e0f2712e7421345c38f0');
        cons.value = "OK.";
        cons.style.height = "1px";
        cons.style.height = (cons.scrollHeight)+"px";
      },
      error: function(err) {
        code.style.borderBottomColor = '#EC0B43';
        document.querySelector('textarea#od4b1c12e1427e0f2712e7421345c38f0').value = err;
        let cons = document.querySelector('textarea#od4b1c12e1427e0f2712e7421345c38f0');
        cons.style.height = "1px";
        cons.style.height = (cons.scrollHeight)+"px";
      },
    })
  : lookup.query(
    `${code.value.substr(3)}`, {
      success: function() {
        code.style.borderBottomColor = '#4DA167';
        document.querySelector('textarea#od4b1c12e1427e0f2712e7421345c38f0').value = "";
        answ();
      },
      error: function(err) {
        code.style.borderBottomColor = '#EC0B43';
        document.querySelector('textarea#od4b1c12e1427e0f2712e7421345c38f0').value = err;
        let cons = document.querySelector('textarea#od4b1c12e1427e0f2712e7421345c38f0');
        cons.style.height = "1px";
        cons.style.height = (cons.scrollHeight)+"px";
      },
    });
}
addEventListener("DOMContentLoaded", (event) => { eval_d4b1c12e1427e0f2712e7421345c38f0() });
</script>
<div style="margin-bottom:24px">
<textarea class="eval_in" id="id4b1c12e1427e0f2712e7421345c38f0" onkeyup="eval_d4b1c12e1427e0f2712e7421345c38f0()">
?- lookup(123, Dict, Value), nonvar(Value).</textarea>
<textarea class="eval_out" readonly id="od4b1c12e1427e0f2712e7421345c38f0"></textarea>
</div>

<p>The Art of Prolog authors Sterling and Shapiro note some other limitations of the dictionary:</p>
<blockquote>
<q>If the key is non-numeric, the predicates &lt; and &gt; must be generalized. The cut is necessary ... because of the nonlogical nature of comparison operators, which will give errors if keys are not instantiated.</q>

<p class="source">&mdash;&nbsp;The Art of Prolog, Chapter 15.3, <em></em></p>

</blockquote>
<p>But that was twenty years ago. Let&rsquo;s refactor it!</p>
<p><script>var lookup2 = pl.create();</script>

<script>

function eval_1248e05526bc63587264b4dbf4af545d() {
  let output = "";
  let answ = function() {
    lookup2.answer({
      success: function(answer) {
        let msg = lookup2.format_answer(answer);
        output += `${msg};\n`;
        answ();
      },
      fail: function() {
        if (output == "") {
          output = "false."
        } else {
          output = output.substr(0, output.length-2) + ".";
        }
        document.querySelector('textarea#o1248e05526bc63587264b4dbf4af545d').value = output;
        let cons = document.querySelector('textarea#o1248e05526bc63587264b4dbf4af545d');
        cons.style.height = "1px";
        cons.style.height = (cons.scrollHeight)+"px";
        output = "";
      },
    });
  };
  let code = document.querySelector('textarea#i1248e05526bc63587264b4dbf4af545d');
  code.style.height = "1px";
  code.style.height = (code.scrollHeight)+"px";
  code.value.substr(0,3) != '?- '
  ? lookup2.consult(
    `${code.value}\n`, { 
      success: function() {
        code.style.borderBottomColor = '#4DA167';
        let cons = document.querySelector('textarea#o1248e05526bc63587264b4dbf4af545d');
        cons.value = "OK.";
        cons.style.height = "1px";
        cons.style.height = (cons.scrollHeight)+"px";
      },
      error: function(err) {
        code.style.borderBottomColor = '#EC0B43';
        document.querySelector('textarea#o1248e05526bc63587264b4dbf4af545d').value = err;
        let cons = document.querySelector('textarea#o1248e05526bc63587264b4dbf4af545d');
        cons.style.height = "1px";
        cons.style.height = (cons.scrollHeight)+"px";
      },
    })
  : lookup2.query(
    `${code.value.substr(3)}`, {
      success: function() {
        code.style.borderBottomColor = '#4DA167';
        document.querySelector('textarea#o1248e05526bc63587264b4dbf4af545d').value = "";
        answ();
      },
      error: function(err) {
        code.style.borderBottomColor = '#EC0B43';
        document.querySelector('textarea#o1248e05526bc63587264b4dbf4af545d').value = err;
        let cons = document.querySelector('textarea#o1248e05526bc63587264b4dbf4af545d');
        cons.style.height = "1px";
        cons.style.height = (cons.scrollHeight)+"px";
      },
    });
}
addEventListener("DOMContentLoaded", (event) => { eval_1248e05526bc63587264b4dbf4af545d() });
</script>
<div style="margin-bottom:24px">
<textarea class="eval_in" id="i1248e05526bc63587264b4dbf4af545d" onkeyup="eval_1248e05526bc63587264b4dbf4af545d()">
lookup(Key, dict(Key1-Value1, Left, Right), Value) :-
  (   Key = Key1 -&gt;
      Value = Value1
  ;   compare(&lt;, Key, Key1) -&gt;
      lookup(Key, Left, Value)
  ;   lookup(Key, Right, Value)
  ).</textarea>
<textarea class="eval_out" readonly id="o1248e05526bc63587264b4dbf4af545d"></textarea>
</div>
</p>
<p>This version uses a single rule, with an if/then control structure to avoid leaving behind choicepoints, since we know each key in the dictionary is unique.</p>
<p>Instead of a numeric comparison, it uses <code>compare/3</code> to sort any key types. This is a newer predicate which uses Prolog&rsquo;s <a href="https://www.metalevel.at/prolog/sorting">standard order</a> so keys can be strings, atoms, numbers, it doesn&rsquo;t matter.</p>
<p>We can make our code clearer by wrapping <code>lookup/3</code> with two new rules: <code>add/3</code> and <code>get/3</code>:</p>
<script>

function eval_078eb6818ae60aa363e83a5990e64f74() {
  let output = "";
  let answ = function() {
    lookup2.answer({
      success: function(answer) {
        let msg = lookup2.format_answer(answer);
        output += `${msg};\n`;
        answ();
      },
      fail: function() {
        if (output == "") {
          output = "false."
        } else {
          output = output.substr(0, output.length-2) + ".";
        }
        document.querySelector('textarea#o078eb6818ae60aa363e83a5990e64f74').value = output;
        let cons = document.querySelector('textarea#o078eb6818ae60aa363e83a5990e64f74');
        cons.style.height = "1px";
        cons.style.height = (cons.scrollHeight)+"px";
        output = "";
      },
    });
  };
  let code = document.querySelector('textarea#i078eb6818ae60aa363e83a5990e64f74');
  code.style.height = "1px";
  code.style.height = (code.scrollHeight)+"px";
  code.value.substr(0,3) != '?- '
  ? lookup2.consult(
    `${code.value}\n`, { 
      success: function() {
        code.style.borderBottomColor = '#4DA167';
        let cons = document.querySelector('textarea#o078eb6818ae60aa363e83a5990e64f74');
        cons.value = "OK.";
        cons.style.height = "1px";
        cons.style.height = (cons.scrollHeight)+"px";
      },
      error: function(err) {
        code.style.borderBottomColor = '#EC0B43';
        document.querySelector('textarea#o078eb6818ae60aa363e83a5990e64f74').value = err;
        let cons = document.querySelector('textarea#o078eb6818ae60aa363e83a5990e64f74');
        cons.style.height = "1px";
        cons.style.height = (cons.scrollHeight)+"px";
      },
    })
  : lookup2.query(
    `${code.value.substr(3)}`, {
      success: function() {
        code.style.borderBottomColor = '#4DA167';
        document.querySelector('textarea#o078eb6818ae60aa363e83a5990e64f74').value = "";
        answ();
      },
      error: function(err) {
        code.style.borderBottomColor = '#EC0B43';
        document.querySelector('textarea#o078eb6818ae60aa363e83a5990e64f74').value = err;
        let cons = document.querySelector('textarea#o078eb6818ae60aa363e83a5990e64f74');
        cons.style.height = "1px";
        cons.style.height = (cons.scrollHeight)+"px";
      },
    });
}
addEventListener("DOMContentLoaded", (event) => { eval_078eb6818ae60aa363e83a5990e64f74() });
</script>
<div style="margin-bottom:24px">
<textarea class="eval_in" id="i078eb6818ae60aa363e83a5990e64f74" onkeyup="eval_078eb6818ae60aa363e83a5990e64f74()">
get(Key, Dict, Value) :-
  lookup(Key, Dict, Value), nonvar(Value).

add(Key, Dict, Value) :-
  lookup(Key, Dict, Value).</textarea>
<textarea class="eval_out" readonly id="o078eb6818ae60aa363e83a5990e64f74"></textarea>
</div>

<p>We also store pairs as the pair type (<code>Key-Value</code>), instead of two separate values. This makes easy to serialize a dictionary into a list of pairs, which are sortable using the builtin <code>keysort/2</code>.</p>
<script>

function eval_e41605e6d0dde41890f88a16f0459877() {
  let output = "";
  let answ = function() {
    lookup2.answer({
      success: function(answer) {
        let msg = lookup2.format_answer(answer);
        output += `${msg};\n`;
        answ();
      },
      fail: function() {
        if (output == "") {
          output = "false."
        } else {
          output = output.substr(0, output.length-2) + ".";
        }
        document.querySelector('textarea#oe41605e6d0dde41890f88a16f0459877').value = output;
        let cons = document.querySelector('textarea#oe41605e6d0dde41890f88a16f0459877');
        cons.style.height = "1px";
        cons.style.height = (cons.scrollHeight)+"px";
        output = "";
      },
    });
  };
  let code = document.querySelector('textarea#ie41605e6d0dde41890f88a16f0459877');
  code.style.height = "1px";
  code.style.height = (code.scrollHeight)+"px";
  code.value.substr(0,3) != '?- '
  ? lookup2.consult(
    `${code.value}\n`, { 
      success: function() {
        code.style.borderBottomColor = '#4DA167';
        let cons = document.querySelector('textarea#oe41605e6d0dde41890f88a16f0459877');
        cons.value = "OK.";
        cons.style.height = "1px";
        cons.style.height = (cons.scrollHeight)+"px";
      },
      error: function(err) {
        code.style.borderBottomColor = '#EC0B43';
        document.querySelector('textarea#oe41605e6d0dde41890f88a16f0459877').value = err;
        let cons = document.querySelector('textarea#oe41605e6d0dde41890f88a16f0459877');
        cons.style.height = "1px";
        cons.style.height = (cons.scrollHeight)+"px";
      },
    })
  : lookup2.query(
    `${code.value.substr(3)}`, {
      success: function() {
        code.style.borderBottomColor = '#4DA167';
        document.querySelector('textarea#oe41605e6d0dde41890f88a16f0459877').value = "";
        answ();
      },
      error: function(err) {
        code.style.borderBottomColor = '#EC0B43';
        document.querySelector('textarea#oe41605e6d0dde41890f88a16f0459877').value = err;
        let cons = document.querySelector('textarea#oe41605e6d0dde41890f88a16f0459877');
        cons.style.height = "1px";
        cons.style.height = (cons.scrollHeight)+"px";
      },
    });
}
addEventListener("DOMContentLoaded", (event) => { eval_e41605e6d0dde41890f88a16f0459877() });
</script>
<div style="margin-bottom:24px">
<textarea class="eval_in" id="ie41605e6d0dde41890f88a16f0459877" onkeyup="eval_e41605e6d0dde41890f88a16f0459877()">
to_list(D,Ls) :-
  to_list_([D|Hole],Hole,[],Ls).

to_list_([D|Ds],Hole,Acc,Ls) :-
  dict(Root,Left,Right) = D,
  (   Left = nil -&gt;
      Hole = Hole1
  ;   Hole = [Left|Hole1]
  ),
  (   Right = nil -&gt;
      Hole1 = Hole2
  ;   Hole1 = [Right|Hole2]
  ),
  (   Ds = [] -&gt;
      Ls=[Root|Acc]
  ;   to_list_(Ds,Hole2,[Root|Acc],Ls)
  ).</textarea>
<textarea class="eval_out" readonly id="oe41605e6d0dde41890f88a16f0459877"></textarea>
</div>

<p>If you change the dictionary key values, you&rsquo;ll see the order of <code>Ms</code> changes:</p>
<script>

function eval_59e014f66fcdcf2aab655617da41d47d() {
  let output = "";
  let answ = function() {
    lookup2.answer({
      success: function(answer) {
        let msg = lookup2.format_answer(answer);
        output += `${msg};\n`;
        answ();
      },
      fail: function() {
        if (output == "") {
          output = "false."
        } else {
          output = output.substr(0, output.length-2) + ".";
        }
        document.querySelector('textarea#o59e014f66fcdcf2aab655617da41d47d').value = output;
        let cons = document.querySelector('textarea#o59e014f66fcdcf2aab655617da41d47d');
        cons.style.height = "1px";
        cons.style.height = (cons.scrollHeight)+"px";
        output = "";
      },
    });
  };
  let code = document.querySelector('textarea#i59e014f66fcdcf2aab655617da41d47d');
  code.style.height = "1px";
  code.style.height = (code.scrollHeight)+"px";
  code.value.substr(0,3) != '?- '
  ? lookup2.consult(
    `${code.value}\n`, { 
      success: function() {
        code.style.borderBottomColor = '#4DA167';
        let cons = document.querySelector('textarea#o59e014f66fcdcf2aab655617da41d47d');
        cons.value = "OK.";
        cons.style.height = "1px";
        cons.style.height = (cons.scrollHeight)+"px";
      },
      error: function(err) {
        code.style.borderBottomColor = '#EC0B43';
        document.querySelector('textarea#o59e014f66fcdcf2aab655617da41d47d').value = err;
        let cons = document.querySelector('textarea#o59e014f66fcdcf2aab655617da41d47d');
        cons.style.height = "1px";
        cons.style.height = (cons.scrollHeight)+"px";
      },
    })
  : lookup2.query(
    `${code.value.substr(3)}`, {
      success: function() {
        code.style.borderBottomColor = '#4DA167';
        document.querySelector('textarea#o59e014f66fcdcf2aab655617da41d47d').value = "";
        answ();
      },
      error: function(err) {
        code.style.borderBottomColor = '#EC0B43';
        document.querySelector('textarea#o59e014f66fcdcf2aab655617da41d47d').value = err;
        let cons = document.querySelector('textarea#o59e014f66fcdcf2aab655617da41d47d');
        cons.style.height = "1px";
        cons.style.height = (cons.scrollHeight)+"px";
      },
    });
}
addEventListener("DOMContentLoaded", (event) => { eval_59e014f66fcdcf2aab655617da41d47d() });
</script>
<div style="margin-bottom:24px">
<textarea class="eval_in" id="i59e014f66fcdcf2aab655617da41d47d" onkeyup="eval_59e014f66fcdcf2aab655617da41d47d()">
?- add(123, Dict, &#34;foo&#34;),
   add(456, Dict, &#34;bar&#34;),
   to_list(Dict, Ls),
   keysort(Ls, Ms).</textarea>
<textarea class="eval_out" readonly id="o59e014f66fcdcf2aab655617da41d47d"></textarea>
</div>

<p>The full Dictionary implementation is on <a href="https://github.com/dnmfarrell/dict">GitHub</a>.</p>
<p><a href="https://github.com/tau-prolog/tau-prolog">Tau Prolog</a> powers this page.</p>


<p>


<em>Tags: 



  
  
  

  <a href=https://blog.dnmfarrell.com/tags/prolog/>prolog</a>



  
  
  

  <a href=https://blog.dnmfarrell.com/tags/data-structures/>data-structures</a>



  
  
  

  <a href=https://blog.dnmfarrell.com/tags/difference-lists/>difference-lists</a>



</em>



</p>


    </main>
    <footer>
</footer>

  </body>
</html>
