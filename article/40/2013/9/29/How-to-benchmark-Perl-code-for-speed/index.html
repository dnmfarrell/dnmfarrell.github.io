<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>How to benchmark Perl code for speed Perl programming news, code and culture</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Benchmarking is easy with the Benchmark module"/>
    <meta name="robots" content="index, follow">
    <link rel="icon" href="/favicon.ico">
    
</head>
<body>

<div class="container antonio">
  <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <ul class="nav navbar-nav pull-right follow">
          <li>FOLLOW US:</li>
          <li><a href="https://twitter.com/intent/follow?screen_name=perltricks">
              <img src="/images/header/twitter_20.png" alt="twitter"></a><li>
          <li><a href="/index.xml" />
              <img src="/images/header/rss_20.png" alt="rss"></a></li>
      </ul>
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
          <a class="navbar-brand" href="/">
          <img src="/images/header/perltricks_logo.png" alt="PerlTricks" />
          </a>
      </div>
      <div class="navbar-collapse collapse">
        <ul class="nav navbar-nav">
          <li><a href="/">
              <div class="circle">
                  <span class="glyphicon glyphicon-home txt-perltricks-blue" aria-hidden="true"></span>
              </div>
                  &nbsp;&nbsp;HOME</a>
          </li>
          <li><a href="/authors">
              <div class="circle">
                  <span class="glyphicon glyphicon-pencil txt-perltricks-blue" aria-hidden="true"></span>
              </div>
                  &nbsp;&nbsp;AUTHORS</a>
          </li>
          <li><a href="/about">
              <div class="circle">
                  <span class="glyphicon glyphicon-user txt-perltricks-blue" aria-hidden="true"></span>
              </div>
                  &nbsp;&nbsp;ABOUT</a>
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>
<div class="push"></div>

  <section id="content" role="main">
    <section class="entry-content">
      <div class="container">
        <div class="row">
          <div class="col-md-9">
            <article>
            <h1 class="blog-post-title">How to benchmark Perl code for speed</h1>
            <p class="blog-post-meta">Sep 29, 2013 by <a href="/authors/david-farrell">David Farrell</a></p>
            <img alt="" src=""/>
              

<p>Benchmarking Perl code speed is easy with the <a href="https://metacpan.org/module/Benchmark">Benchmark</a> module. This article discusses benchmarking in general and how to use the <a href="https://metacpan.org/module/Benchmark">Benchmark</a> module.</p>

<h3 id="what-is-a-benchmark:9f13c3fb84d6c1f3b2fdc2b107f646bd">What is a benchmark?</h3>

<p>In programming a benchmark is a point-in-time measurement of the performance of a some code. Any aspect of the code performance can be benchmarked: speed, memory use and IO frequency are some common metrics.</p>

<h3 id="benchmark-limitations:9f13c3fb84d6c1f3b2fdc2b107f646bd">Benchmark limitations</h3>

<p>One thing to keep in mind with benchmarks is that they are affected by the environment: the operating system, hardware, software and current machine state can all affect the benchmark. For Perl code the current Perl version and the compile options that Perl was installed with can have significant affects on code performance. For example if Perl was compiled with iThreads enabled, this increases the overhead of all Perl programs. Therefore benchmark comparisons are only meaningful when the benchmark environments are the same.</p>

<h3 id="perl-s-benchmark-module:9f13c3fb84d6c1f3b2fdc2b107f646bd">Perl&rsquo;s Benchmark Module</h3>

<p><a href="https://metacpan.org/module/Benchmark">Benchmark</a> comes installed in Perl core so if you have Perl installed you should already have Benchmark installed as well. If you are on a UNIX-like system then consider installing <a href="https://metacpan.org/module/Benchmark::Forking">Benchmark::Forking</a> as it can improve the accuracy of benchmarks. <a href="https://metacpan.org/module/Benchmark::Forking">Benchmark::Forking</a> is a drop-in replacement for <a href="https://metacpan.org/module/Benchmark">Benchmark</a> and all of the following code examples will work with either module.</p>

<h3 id="timing-perl-code:9f13c3fb84d6c1f3b2fdc2b107f646bd">Timing Perl Code</h3>

<p>Benchmarks are most interesting when comparing performance of code - so we&rsquo;re going to focus on methods that do that. Benchmark provides a &ldquo;timethese&rdquo; subroutine which continuously executes sets of Perl code for a number of CPU seconds and then prints out the results. Let&rsquo;s compare the speed difference of two common Perl operations: array assignment using the shift built in function and direct array assignment using equals:</p>

<pre><code class="language-prettyprint">use strict;
use warnings;
use Benchmark qw/cmpthese timethese/;

timethese(-10, {
        shiftAssign =&gt; sub {    my @alphabet = ('A'..'Z');
                                for (my $i = 0; $i &lt; 26; $i++){
                                    my $letter = shift @alphabet;
                                }
                           },
        equalsAssign =&gt; sub {   my @alphabet = ('A'..'Z');
                                for (my $i = 0; $i &lt; 26; $i++){
                                    my $letter = $alphabet[$i];
                                }
                            },
});
</code></pre>

<p>Running the code above yielded the following results:</p>

<pre><code class="language-prettyprint">Benchmark: running equalsAssign, shiftAssign for at least 10 CPU seconds...
equalsAssign: 10 wallclock secs (10.32 usr +  0.00 sys = 10.32 CPU) @ 150112.98/s (n=1549166)
shiftAssign: 11 wallclock secs (10.43 usr +  0.00 sys = 10.43 CPU) @ 148529.82/s (n=1549166)
</code></pre>

<p>The key metric to focus on is the rate per CPU second. This shows that the shiftAssign code block was executed 148,529.82/s and the equalsAssign block was slightly faster, executing 150,112.98/s. Note that the testing of each block ran for different amounts of time - so the other numbers in the output are not directly comparable.</p>

<h3 id="comparing-perl-code:9f13c3fb84d6c1f3b2fdc2b107f646bd">Comparing Perl Code</h3>

<p>The &ldquo;cmpthese&rdquo; subroutine provided the Benchmark module accepts the same arguments and &ldquo;timethese&rdquo; shown above, but prints out a useful comparison grid of the results to show which code block was faster by %. Helpfully it also includes the rate per CPU second.</p>

<pre><code class="language-prettyprint">use strict;
use warnings;
use Benchmark qw/cmpthese timethese/;

cmpthese(-10, {
        shiftAssign =&gt; sub {    my @alphabet = ('A'..'Z');
                                for (my $i = 0; $i &lt; 26; $i++){
                                    my $letter = shift @alphabet;
                                }
                           },
        equalsAssign =&gt; sub {   my @alphabet = ('A'..'Z');
                                for (my $i = 0; $i &lt; 26; $i++){
                                    my $letter = $alphabet[$i];
                                }
                            },
});
</code></pre>

<p>Executing this code returned the following results:</p>

<pre><code class="language-prettyprint">                 Rate  shiftAssign equalsAssign
shiftAssign  142529/s           --          -4%
equalsAssign 148159/s           4%           --
</code></pre>

<p>The results above are ordered from slowest to fastest (as seen by the rate/s measurement). This benchmark shows that the equalsAssign code block was on average 4% faster than the shiftAssign code block.</p>

<h3 id="additional-tips:9f13c3fb84d6c1f3b2fdc2b107f646bd">Additional Tips</h3>

<ul>
<li>Try to use the minimum set of code required for the behavior required - this will increase the accuracy of the benchmark pertaining to operations being benchmarked.</li>
<li>Use a negative number as the CPU seconds count for &ldquo;timethese&rdquo; or &ldquo;cmpthese&rdquo;. This specifies the minimum number of CPU seconds to run. <a href="http://www.perlmonks.org/?node_id=8745">Some sources</a> recommend at least -5 seconds to avoid inaccurate benchmarks.</li>
<li>Sanity check your results: if you&rsquo;re not sure try comparing two code blocks with one obviously slower than the other to check that Benchmark is returning sensible results.</li>
<li>Compare code examples rather than time individual ones: the actual execution time of a block of code is usually not that important; knowing which set of code is faster than the other however is useful as this will generally be a repeatable occurrence.</li>
<li>If you require more in depth benchmarking consider using <a href="https://metacpan.org/module/Devel::NYTProf">Devel::NYTProf</a>.</li>
</ul>

<h3 id="sources:9f13c3fb84d6c1f3b2fdc2b107f646bd">Sources</h3>

<p>This article drew on information from a few sources in particular: brian d foy&rsquo;s <a href="http://www252.pair.com/comdog/Talks/benchmarking_perl.pdf">Benchmarking Perl</a> talk notes and David Golden&rsquo;s <a href="http://www.dagolden.com/index.php/1849/adventures-in-benchmarking-part-1/">Adventures in Benchmarking</a> post.</p>

            </article>
            <p><strong>Tags</strong></p>
            <div class="tags">
              
                <div class="tag"><a href="/tags/benchmarking">benchmarking</a></div>
              
                <div class="tag"><a href="/tags/module">module</a></div>
              
                <div class="tag"><a href="/tags/core">core</a></div>
              
                <div class="tag"><a href="/tags/old_site">old_site</a></div>
              
            </div>
            <div class="push"></div>
          </div>
          <div class="col-md-3">
            <div class="latest-sidebar">

  <div class="row">
    <div class="col-sm-12 centering">
      <span style="font-size:1.8em" class="antonio txt-perltricks-blue">OUR LATEST ARTICLES</span>
    </div>
  </div>
  
        
        
  <div class="row">
      <a href="http://perltricks.com/article/an-introduction-to-tmux/">
    <div class="col-sm-3">
      <div class="circle-avatar" style="background-image:url(http://googledrive.com/host/0BwRnByTz2iUXazVBdzNFRU1QV1k)"></div>
    </div>
    <div class="col-sm-9">
        <h6>An introduction to Tmux</h6>
        <p style="line-height:1"><small>How to get started with the open source terminal multiplexer </small></p>
    </div>
      </a>
  </div>
  
        
        
  <div class="row">
      <a href="http://perltricks.com/article/magical-tied-scalars/">
    <div class="col-sm-3">
      <div class="circle-avatar" style="background-image:url(/images/author/brian.jpg)"></div>
    </div>
    <div class="col-sm-9">
        <h6>Magical tied scalars</h6>
        <p style="line-height:1"><small>Subvert and simplify code with tied scalars</small></p>
    </div>
      </a>
  </div>
  
        
        
  <div class="row">
      <a href="http://perltricks.com/article/213/2016/2/10/What-s-new-on-CPAN---January-2015/">
    <div class="col-sm-3">
      <div class="circle-avatar" style="background-image:url(/images/213/AF57B300-5234-11E5-B481-F86745487EAA.png)"></div>
    </div>
    <div class="col-sm-9">
        <h6>What&#39;s new on CPAN - January 2016</h6>
        <p style="line-height:1"><small>A curated look at January&#39;s new CPAN uploads</small></p>
    </div>
      </a>
  </div>
  
        
        
  <div class="row">
      <a href="http://perltricks.com/article/212/2016/2/2/Get-an-in-browser-remote-desktop-with-Mojolicious-and-noVNC/">
    <div class="col-sm-3">
      <div class="circle-avatar" style="background-image:url(/images/212/0156BEFE-C9B2-11E5-A2BB-E80C3AD1818C.jpeg)"></div>
    </div>
    <div class="col-sm-9">
        <h6>Get an in-browser remote desktop with Mojolicious and noVNC</h6>
        <p style="line-height:1"><small>Using Mojolicious as a TCP/WebSocket Bridge</small></p>
    </div>
      </a>
  </div>
  
        
        
  <div class="row">
      <a href="http://perltricks.com/article/210/2016/1/21/Twitter-as-a-datastore/">
    <div class="col-sm-3">
      <div class="circle-avatar" style="background-image:url(/images/210/B6ABE53E-C045-11E5-B2C3-641B7A54B0AF.png)"></div>
    </div>
    <div class="col-sm-9">
        <h6>Twitter as a datastore</h6>
        <p style="line-height:1"><small>Using social media platforms for computing applications</small></p>
    </div>
      </a>
  </div>
  
</div>

            <div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
    <a class="twitter-timeline" data-dnt="true" href="https://twitter.com/PerlTricks" data-widget-id="618973837762383879">Tweets by @PerlTricks</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </div>
</div>

            </div>
          </div>
        </div>
      </div>
    </section>
  </section>
<div class="push"></div>
<div class="footer">
  <div class="container">
    <div class="row">
      <div class="col-md-1">
        <h5>Site Map</h5>
        <ul>
        <li><a href="/about">About</a></li>
        <hr>
        <li><a href="/">Articles</a></li>
        <hr>
        <li><a href="/authors">Authors</a></li>
        <hr>
        </ul>
      </div>
      <div class="col-md-4">
        <h5>Contact Us</h5>
        <p>To get in touch, send an email to: editor@perltricks.com</p>
        <p>Follow us:&nbsp;
        <a href="https://twitter.com/intent/follow?screen_name=perltricks">
            <img src="/images/footer/twitter_20_dark.png" alt="twitter"></a>
          <a href="/index.xml" /><img src="/images/footer/rss_20_dark.png" alt="rss"></a></p>
          <p>&copy; <span id="year"></span> PerlTricks.com</p>
      </div>
      <div class="col-md-7">
          <h5>Legal</h5>
          <p>PerlTricks.com and the authors make no representations or warranties with respect to the accuracy or completeness of the contents of all work on this website and specifically disclaim all warranties, including without limitation warranties of fitness for a particular purpose. No warranty may be created or extended. The advice and strategies published on this website may not be suitable for every situation. All work on this website is provided with the understanding that PerlTricks.com and the authors are not engaged in rendering legal, accounting, or other professional services. Neither PerlTricks.com nor the authors shall be liable for damages arising herefrom.</p>
      </div>
    </div>
  </div>
</div>
<link href="/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="/css/perltricks.css"/>
<script src="/javascript/jquery.min.js"></script>
<script src="/javascript/bootstrap.min.js"></script>
<script src="/javascript/prettify.min.js"></script>
<script>document.getElementById("year").innerHTML = (new Date()).getFullYear();prettyPrint();</script>
</body>
</html>

